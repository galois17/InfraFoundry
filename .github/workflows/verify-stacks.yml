name: Verify Infrastructure Stacks

on:
  push:
    paths:
      - 'stacks/**'
      - '.github/workflows/verify-stacks.yml'

  pull_request:
    paths:
      - 'stacks/**'

  # run daily ‚Äî job will self-skip except month end
  schedule:
    - cron: '0 8 * * *'

  workflow_dispatch:

jobs:
  test-stack:
    name: Test ${{ matrix.stack_path }}
    runs-on: ubuntu-latest
    timeout-minutes: 10

    strategy:
      fail-fast: false
      matrix:
        stack_path:
          - stacks/n8n-standalone/docker
          #- stacks/n8n-rabbitmq/docker

    steps:
      # ---------------------------------------------------
      # MONTH-END GUARD (KEY PART)
      # ---------------------------------------------------
      - name: Check if last day of month
        id: month_check
        shell: bash
        run: |
          # Only apply guard to scheduled runs
          if [ "${{ github.event_name }}" != "schedule" ]; then
            echo "Not a scheduled run -> always run."
            echo "skip=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          TODAY=$(date -u +%d)
          TOMORROW=$(date -u -d "tomorrow" +%d)

          if [ "$TOMORROW" = "01" ]; then
            echo "Last day of month. Running full test."
            echo "skip=false" >> $GITHUB_OUTPUT
          else
            echo "üõë Not last day of month. Skipping heavy CI."
            echo "skip=true" >> $GITHUB_OUTPUT
          fi

      # REAL WORK (runs only when not skipped)

      - name: Checkout Code
        if: steps.month_check.outputs.skip != 'true'
        uses: actions/checkout@v4

      - name: Configure Environment (.env)
        if: steps.month_check.outputs.skip != 'true'
        working-directory: ${{ matrix.stack_path }}
        run: |
          if [ -f .env.example ]; then
            echo "Creating .env from example..."
            cp .env.example .env
          else
            echo "::warning::No .env.example found in ${{ matrix.stack_path }}"
          fi

      - name: Start Stack
        if: steps.month_check.outputs.skip != 'true'
        working-directory: ${{ matrix.stack_path }}
        run: |
          echo "Starting Docker Compose..."
          docker compose up -d

      - name: Wait for Healthy Containers
        if: steps.month_check.outputs.skip != 'true'
        working-directory: ${{ matrix.stack_path }}
        run: |
          echo "Waiting for services to stabilize (max 60s)..."

          for i in {1..12}; do
            UNHEALTHY_COUNT=$(docker ps --format "{{.Status}}" | grep -i "unhealthy" | wc -l)
            STARTING_COUNT=$(docker ps --format "{{.Status}}" | grep -i "starting" | wc -l)

            if [ "$UNHEALTHY_COUNT" -eq "0" ] && [ "$STARTING_COUNT" -eq "0" ]; then
              echo "All containers are running and healthy!"
              docker ps
              exit 0
            fi

            echo "‚è≥ Waiting... ($STARTING_COUNT starting, $UNHEALTHY_COUNT unhealthy)"
            sleep 5
          done

          echo "‚ùå Timeout waiting for health checks."
          exit 1

      - name: Verify n8n HTTP Response
        if: steps.month_check.outputs.skip != 'true'
        run: |
          echo "Testing http://localhost:5678/healthz ..."
          timeout 30s bash -c 'until curl --silent --fail http://localhost:5678/healthz; do sleep 2; done'
          echo "‚úÖ n8n web interface is reachable!"

      - name: Dump Logs on Failure
        if: failure() && steps.month_check.outputs.skip != 'true'
        working-directory: ${{ matrix.stack_path }}
        run: |
          echo "::group::Docker Compose Logs"
          docker compose logs
          echo "::endgroup::"
          echo "::group::Container Inspection"
          docker ps -a
          echo "::endgroup::"